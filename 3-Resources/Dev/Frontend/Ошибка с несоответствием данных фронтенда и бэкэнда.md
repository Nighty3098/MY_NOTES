---
tags:
  - frontend
---
![[Pasted image 20250416140008.png]]



Ошибка выглядит следующим образом:

```
POST http://localhost:5000/api/rename_column 404 (NOT FOUND)
Uncaught (in promise) Error: Column not found
```

При этом данные корректно сохраняются в базу данных, и после обновления страницы колонка отображается с новым названием. Давайте разберем причину этой проблемы и предложим решение.

---

#### Описание проблемы

Ошибка возникает из-за несоответствия идентификаторов (ID) колонок между фронтендом и бэкендом. Вот что происходит:

1. **Создание колонки**:
   - На фронтенде в функции `createNewKanbanBlock` вы создаете новую колонку с локально сгенерированным ID с помощью `generateId()` (например, случайная строка вроде `"abc123"`).
   - Затем вы добавляете эту колонку в локальное состояние (`setBoards`) и вызываете API-метод `api.createColumn`, чтобы сохранить колонку на сервере.
   - Однако в текущей реализации `api.createColumn` не возвращает ID, сгенерированный сервером, и фронтенд продолжает использовать локальный ID.

2. **Переименование колонки**:
   - Сразу после создания вы пытаетесь переименовать колонку, вызывая `api.renameColumn` с локальным ID.
   - Бэкенд получает запрос на переименование, но не может найти колонку с этим ID, так как сервер сгенерировал свой собственный ID (например, `"xyz789"`) при создании колонки. В результате возвращается ошибка `404 (Column not found)`.

3. **После обновления страницы**:
   - При перезагрузке страницы фронтенд загружает данные с сервера через `api.loadBoards`, и колонки получают правильные ID, сгенерированные сервером. Поэтому после обновления переименование работает корректно.

---

#### Причина ошибки

Основная причина — **несинхронизированность ID между фронтендом и бэкендом**. В текущем коде:

- Фронтенд использует локально сгенерированный ID для новой колонки.
- Бэкенд (в `CreateColumn`) создает колонку с новым ID и возвращает его в ответе `{"message": message, "column_id": column_id}`.
- Однако фронтенд не обрабатывает этот ответ и не обновляет локальное состояние с серверным ID.

Когда вы вызываете `api.renameColumn`, запрос отправляется с неправильным (локальным) ID, что приводит к ошибке.

---

#### Решение

Чтобы устранить проблему, нужно синхронизировать ID колонки на фронтенде с тем, что возвращает сервер. Для этого необходимо:

1. **Изменить `api.createColumn`, чтобы он возвращал `column_id`**:
   Текущая реализация `api.createColumn` возвращает `Promise<void>` и игнорирует ответ сервера. Нужно изменить её, чтобы она возвращала `column_id`.

   Вот исправленный код в `api.ts`:

   ```typescript
   async createColumn(token: string, board_id: string, title: string, color: string): Promise<string> {
     try {
       const response = await axios({
         method: "post",
         url: `${API_URL}/create_column`,
         data: { board_id: board_id, title: title, color: color },
         headers: {
           Authorization: token,
           "Content-Type": "application/json",
         },
       });
       return response.data.column_id; // Возвращаем ID колонки из ответа сервера
     } catch (error) {
       if (axios.isAxiosError(error)) {
         throw new Error(error.response?.data?.message || "Failed to create column");
       }
       throw error;
     }
   }
   ```

2. **Обновить `createNewKanbanBlock`, чтобы использовать серверный ID**:
   Функция должна дождаться ответа от `api.createColumn` и использовать полученный `column_id` для создания колонки в локальном состоянии.

   Исправленный код в `TasksTab.tsx`:

   ```typescript
   const createNewKanbanBlock = async () => {
     if (!currentBoardId) return;

     try {
       // Ждем ответа от сервера с ID новой колонки
       const columnId = await api.createColumn(token, currentBoardId, "New Column", "var(--blur)");

       // Создаем новую колонку с серверным ID
       const newColumn: ColumnType = {
         id: columnId,
         title: "New Column",
         color: "var(--blur)",
         tasks: [],
         boardId: currentBoardId,
       };

       // Обновляем локальное состояние
       setBoards(boards.map(board =>
         board.id === currentBoardId
           ? { ...board, columns: [...board.columns, newColumn] }
           : board
       ));
     } catch (error) {
       console.error("Ошибка при создании колонки:", error);
     }
   };
   ```

---

#### Почему это работает

- Теперь фронтенд использует тот же ID, который был сгенерирован сервером при создании колонки.
- Когда вы вызываете `api.renameColumn(token, columnId, tempTitle)`, передается правильный `columnId`, и сервер успешно находит колонку для переименования.
- Ошибка `404 (Column not found)` больше не возникает, так как ID синхронизированы.

---

#### Дополнительные рекомендации

1. **Обработка ошибок**:
   В случае сбоя API-запроса (например, сервер не отвечает), добавьте уведомление пользователю или откат изменений в локальном состоянии.

   ```typescript
   catch (error) {
     console.error("Ошибка при создании колонки:", error);
     alert("Не удалось создать колонку. Попробуйте еще раз.");
   }
   ```

2. **Асинхронность в UI**:
   Поскольку `createNewKanbanBlock` теперь асинхронная, убедитесь, что кнопка, вызывающая эту функцию (в `TasksHeader`), корректно обрабатывает ожидание (например, добавьте индикатор загрузки).

3. **Проверка бэкенда**:
   Убедитесь, что эндпоинт `/api/rename_column` на бэкенде работает корректно и принимает `column_id` в теле запроса. Судя по ошибке `"Column not found"`, эндпоинт существует, но получает неверный ID.

---

#### Итог

Проблема возникает из-за того, что фронтенд использует локальный ID, а бэкенд — свой собственный. Исправив `api.createColumn` и `createNewKanbanBlock`, вы синхронизируете ID, и переименование будет работать сразу после создания колонки, без необходимости обновления страницы.