---
tags:
  - CPP
  - MemUsage
  - Optimization
---
## Основные операторы управления памятью

В C++ используются следующие операторы для управления динамической памятью:

- **`new`**: выделяет память для одного объекта или массива объектов и вызывает конструктор.
- **`delete`**: освобождает память, занятую одним объектом и вызывает деструктор.
- **`new[]`**: выделяет память для массива объектов.
- **`delete[]`**: освобождает память, занятую массивом объектов.

### Пример использования `new` и `delete`

```cpp
#include <iostream>

class MyClass {
public:
    MyClass() {
        std::cout << "Конструктор вызван" << std::endl;
    }
    ~MyClass() {
        std::cout << "Деструктор вызван" << std::endl;
    }
};

int main() {
    // Выделение памяти для одного объекта
    MyClass* obj = new MyClass();

    // Освобождение памяти
    delete obj;

    return 0;
}
```

### Пример использования `new[]` и `delete[]`

```cpp
#include <iostream>

int main() {
    int n = 5;
    
    // Выделение памяти для массива из 5 целых чисел
    int* array = new int[n];

    // Инициализация массива
    for (int i = 0; i < n; i++) {
        array[i] = i + 1;
    }

    // Вывод значений массива
    for (int i = 0; i < n; i++) {
        std::cout << array[i] << " ";
    }
    
    std::cout << std::endl;

    // Освобождение памяти
    delete[] array;

    return 0;
}
```

## Проблемы ручного управления памятью

### Утечки памяти

Утечка памяти происходит, когда выделенная динамически память не освобождается после использования. Это может привести к постепенному уменьшению свободной памяти и замедлению работы программы. Причины утечек могут включать:

- Неправильное использование операторов `new` и `delete`.
- Забывание освободить память, возвращаемую из функций.
- Потеря указателей на выделенную память.

#### Пример утечки памяти

```cpp
#include <iostream>

void memoryLeak() {
    int* leak = new int[10]; // Выделение памяти
    // Здесь нет вызова delete[], что приводит к утечке памяти
}

int main() {
    memoryLeak();
    
    // Программа завершится, но память не будет освобождена
    return 0;
}
```

### Висячие ссылки

Висячие ссылки (или висячие указатели) возникают, когда указатель указывает на область памяти, которая была освобождена. Попытка доступа к такой области может привести к неопределенному поведению программы.

#### Пример висячего указателя

```cpp
#include <iostream>

int main() {
    int* ptr = new int(42);
    
    delete ptr; // Освобождение памяти
    
    // Теперь ptr является висячим указателем
    std::cout << *ptr; // Неопределенное поведение

    return 0;
}
```

## Советы по предотвращению ошибок управления памятью

1. **Используйте умные указатели**: Умные указатели (например, `std::unique_ptr`, `std::shared_ptr`) автоматически управляют жизненным циклом объектов и освобождают память при выходе из области видимости.

   ```cpp
   #include <iostream>
   #include <memory>

   class MyClass {
   public:
       MyClass() { std::cout << "Конструктор вызван" << std::endl; }
       ~MyClass() { std::cout << "Деструктор вызван" << std::endl; }
   };

   int main() {
       std::unique_ptr<MyClass> obj(new MyClass());
       // Объект будет автоматически удален при выходе из области видимости
       return 0;
   }
   ```

2. **Регулярно проверяйте код на утечки**: Используйте инструменты для анализа кода и отладки, такие как Valgrind или AddressSanitizer.

3. **Соблюдайте правила выделения и освобождения**: Всегда следите за тем, чтобы каждый вызов `new` имел соответствующий вызов `delete`, а каждый вызов `new[]` — соответствующий вызов `delete[]`.


[1] https://ru.wikipedia.org/wiki/%D0%A1%D0%B1%D0%BE%D1%80%D0%BA%D0%B0_%D0%BC%D1%83%D1%81%D0%BE%D1%80%D0%B0
[2] https://habr.com/ru/articles/490640/
[3] https://pikabu.ru/story/pro_utechku_pamyati_v_c_i_kak_s_ney_byit_10736715
[4] https://studfile.net/preview/3368742/
[5] https://proproprogs.ru/c_base/cpp-operatory-new-delete
[6] https://learn.microsoft.com/ru-ru/cpp/c-runtime-library/find-memory-leaks-using-the-crt-library?view=msvc-170
[7] https://skillbox.ru/media/code/utechki_pamyati_v_c_chto_eto_takoe_i_chem_oni_opasny/